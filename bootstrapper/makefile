# Installer makefile

WIX_BIN_DIR=%wix%bin
CANDLE_="$(WIX_BIN_DIR)\candle.exe"
CANDLE="$(CANDLE_)"

BOOT_EXTENSIONS=\
	-ext WixBalExtension.dll \
	-ext WixUtilExtension.dll

# set the architecture [x86, x64, or ia64]
BOOT_CANDLE_FLAGS=\
	-arch x86 \
	-dBIN_DIR=$(BIN_DIR)

LIGHT_="$(WIX_BIN_DIR)\light.exe"
LIGHT="$(LIGHT_)"

# disable warning LGHT1076 generated by the Microsoft CRT Merge Modules
BOOT_LIGHT_FLAGS=\
	-sw1076

# define some common directories
BIN_DIR=..\bin

APP_DIR=..\application
APP_SRC_DIR=$(APP_DIR)\src
APP_OBJ_DIR=$(APP_DIR)\obj

INST_DIR=..\installer
INST_OBJ_DIR=$(INST_DIR)\obj
INST_SRC_DIR=$(INST_DIR)\src

BOOT_OBJ_DIR=obj
BOOT_SRC_DIR=src

!include common.mak
!include $(INST_DIR)\common.mak
!include $(APP_DIR)\common.mak

BOOT_TARGET=$(BIN_DIR)\$(BOOTSTRAPPER_TARGET_NAME)

BOOT_OBJECTS=\
	$(BOOT_OBJ_DIR)\main.wixobj

# enable our custom inference rule for .wxs files
.SUFFIXES: .wxs

all: $(BOOT_TARGET)

# link application.exe from all the dependent objects
$(BOOT_TARGET): $(BOOT_OBJECTS)
	$(LIGHT) $(BOOT_EXTENSIONS) $(BOOT_LIGHT_FLAGS) -out $(BOOT_TARGET) $(BOOT_OBJECTS)

# main.wxs references our application executable so make sure nmake knows it is a dependent
$(BOOT_OBJ_DIR)\main.wixobj: $(BIN_DIR)\$(INST_TARGET_NAME)

# compile src/*.wxs files to obj/*.wixobj files
{$(BOOT_SRC_DIR)}.wxs{$(BOOT_OBJ_DIR)}.wixobj:
	$(CANDLE) $(BOOT_EXTENSIONS) $(BOOT_CANDLE_FLAGS) -out $(BOOT_OBJ_DIR)\%|fF.wixobj $<

# include the installer makefile to gather all the dependencies
!include $(INST_DIR)\makefile

# double colon as clean already has a description block in $(APP_DIR)\makefile
clean::
	del /q $(BOOT_OBJECTS)
	del /q $(BOOT_TARGET)
