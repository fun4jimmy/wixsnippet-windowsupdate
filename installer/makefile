# Installer makefile

WIX_BIN_DIR=%wix%bin
CANDLE_="$(WIX_BIN_DIR)\candle.exe"
CANDLE="$(CANDLE_)"

# set the architecture [x86, x64, or ia64]
INST_CANDLE_FLAGS=\
	-arch x86

LIGHT_="$(WIX_BIN_DIR)\light.exe"
LIGHT="$(LIGHT_)"

# disable warning LGHT1076 generated by the Microsoft CRT Merge Modules
INST_LIGHT_FLAGS=\
	-sw1076

# define some common directories
BIN_DIR=..\bin

!ifndef APP_DIR
APP_DIR=..\application
!endif

!ifndef APP_SRC_DIR
APP_SRC_DIR=$(APP_DIR)\src
!endif

!ifndef APP_OBJ_DIR
APP_OBJ_DIR=$(APP_DIR)\obj
!endif

!ifndef INST_OBJ_DIR
INST_OBJ_DIR=obj
!endif

!ifndef INST_SRC_DIR
INST_SRC_DIR=src
!endif

!include common.mak
!include $(APP_DIR)\common.mak

INST_TARGET=$(BIN_DIR)\$(INST_TARGET_NAME)

INST_OBJECTS=\
	$(INST_OBJ_DIR)\main.wixobj

# enable our custom inference rule for .wxs files
.SUFFIXES: .wxs

all: $(INST_TARGET)

# link application.exe from all the dependent objects
$(INST_TARGET): $(INST_OBJECTS)
	$(LIGHT) $(INST_LIGHT_FLAGS) -out $(INST_TARGET) $(INST_OBJECTS)

# main.wxs references our application executable so make sure nmake knows it is a dependent
$(INST_OBJ_DIR)\main.wixobj: $(BIN_DIR)\$(APP_TARGET_NAME)

# compile src/*.wxs files to obj/*.wixobj files
{$(INST_SRC_DIR)}.wxs{$(INST_OBJ_DIR)}.wixobj:
	$(CANDLE) $(INST_CANDLE_FLAGS) -out $(INST_OBJ_DIR)\%|fF.wixobj $<

# include the application makefile to gather all the dependencies
!include $(APP_DIR)\makefile

# double colon as clean already has a description block in $(APP_DIR)\makefile
clean::
	del /q $(INST_OBJECTS)
	del /q $(INST_TARGET)
